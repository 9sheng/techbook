## 14 高性能数据库集群：读写分离
- mysql 是主从集群，不是主备集群
- 主从复制延迟的解决
  - 写操作后的读指定发给数据库主服务器
  - 二次读取：读丛机失败后再读一次主机
  - 关键业务读写都指向主机，非关键业务采用读写分离

## 15 高性能数据库集群：分库分表
- 降低存储压力
- 业务分库：按照业务模块将数据分散到不同的数据库服务器
  - 问题：join操作，事务，成本（一般来说单台数据库能支撑10万用户量量级的业务）
- 分表：有公司要求单表行数超过5000万必须分表
  - 垂直分表、水平分表
  - 问题：join 操作，count 操作，order by 操作
- 优化顺序
  1. 优化硬件，如 HDD 改为 SSD
  1. 数据库优化，如增加索引
  1. 引入缓存，如 redis
  1. 程序和数据库 scheme 优化，重构，减少不必要的查询
  1. 分库分表，要有预估

# 16 高性能 NoSQL
常见 NoSQL
- KV 存储，如 redis
- 文档数据库，如 MongoDB
- 列式数据库，如 HBase
  - 行数据库压缩率一般在 3:1 和 5:1 之间，列数据库压缩率在 8:1 和 30:1 之间，行数据库读取时必须将所有的字段读出来，列数据库可读指定列，减少 IO 次数
- 全文检索引擎：如 Elasticsearch

**RDB**
文章：当我们聊技术实力的时候，我们到底在聊什么

## 17 高性能缓存架构
缓存的内容是什么，触发缓存的方式和时机，缓存的层次和粒度，缓存的命名规范和失效规则、缓存监控指标和故障应对方案，缓存可视化（如key大小）

- 单台 Memcache 服务器的 kv 查询能达到5万 TPS 以上
- 缓存穿透：数据不存在，缓存数据生成耗费大量时间、资源
- 缓存雪崩：缓存失效（过期）引起系统性能急剧下降的情况
  - 网友双 key 策略，一个 key 有过期，另一个 key1 无过期，读取 key 时候，如果 key 过期，返回 key1 的值，并触发事件同时更新 key 和 key1
- 缓存预热：系统上线后将数据直接加入到缓存系统
- 缓存热点：复制多份缓存副本，随机访问其中一个，不要设置统一的过期时间

## 18 单服务器高性能模式 PPC与TPC
- PPC：Process Per Connection
  - 一个子进程服务一次请求，fork 代价太大
  - prefork，多个子进程 accept 同一个 socket，惊群现象，Linux2.6版本已经解决
  - 适合数据库，中间件之类的，不会因为进程hang住而崩溃
- TPC：Thread Per Connection
  - prethread，Apache 服务器的MPM worker 本质上就是一种 prethread 方案，具体是先创建多个进程，每个进程创建多个线程

响应时间（RT），并发数（Concurrency），吞吐量（TPS），吞吐量=并发数/平均响应时间
- 三高系统，如秒杀、即时通讯不能使用
- 三低系统，如ToB，运营类、管理类系统一般可以使用
- 高吞吐量系统，如果以内存计算为主，一般可以使用，如果是网络IO为主，一般不使用
- 适用于吞吐量大，长连接且连接数不多的系统，不支持高并发

## 19 单服务器高性能模式 Reactor 与 Proactor
两种I/O多路复用模式：Reactor 和 Proactor，Reactor模式采用同步 IO，而Proactor采用异步 IO，异步情况下(Proactor)，当回调handler时，表示IO操作已经完成；同步情况下(Reactor)，回调handler时，表示IO设备可以进行某个操作(can read or can write)。
- Reactor 模式也叫 Dispatcher 模式
  - 事件来了我通知你，你来处理
  - 单 Reactor 单线程/进程，如redis
  - 单 Reactor 多线程/进程
  - 多 Reactor 多线程/进程，如Nginx(进程）， Memcache和Netty（线程）
- Proactor：非阻塞同步网络模型
  - 来了事件我（OS）来处理，处理完了我通知你（应用）
  - 理论上 Proactor 比 Reactor 更高效一些，异步IO能重复利用DMA特性
  - 目前 Windows 下通过IOCP真正实现了异步 IO，Linux 下的 AIO 不完善

## 20 高性能负载均衡：分类及架构
- DNS 负载均衡
  - 简单、成本低；就近访问，提升访问速度
  - 更新不及时，DNS 缓存时间比较长；可扩展性差，控制器在域名商；分配策略比较简单
- 硬件负载均衡
  - F5 和 A10
  - 能支持并发100万以上，稳定性好；但贵，扩展能力差
- 软件负载均衡
  - nginx：7层负载均衡
  - LVS：4层负载均衡
  - HAProxy：SLB
- 一般一个 linux 上装一个 nginx 大概5万/秒，LVS性能是10万级，据说可以达到80万，F5的性能是百万级，从200万到800万都有

## 21 高性能负载均衡：算法
- 轮询
- 加权轮询
- 负载最低优先（站在服务器角度分析）
  - 最小连接数优先
  - CPU负载最低优先
- 性能最优类（站在客户端角度分析）
  实现较复杂，需要根据场景决定具体策略
- hash 类
