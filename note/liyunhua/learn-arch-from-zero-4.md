## 31 如何应对接口级故障
- 降级，应对系统自身的故障，停用部分非重要功能
  - 系统后门降级，如通过访问系统降级 url 实现
  - 独立降级系统
- 熔断，应对依赖的外部系统故障
  - 需要集中统计接口的调用状况
- 限流，从用户访问压力方面考虑
  - 基于请求的限流，限制请求量
  - 基于资源的限流，如连接数、文件句柄、线程数、请求队列、CPU 占用率
- 排队，限流的变种
  - 实现单独的排队模块，调度模块

## 32 可扩展架构的基本思想和模式
- 可扩展的基本思想：拆分；合理的拆分，即使程序员出错，会让出错的范围不会太广，影响不会太大
  - 面向流程拆分：分层架构
  - 面向服务拆分：SOA、微服务
  - 面向功能拆分：微内核架构

## 33 传统的可扩展架构模式：分层架构和SOA
- 分层结构
  - C/S B/S
  - MVC 架构、MVP 架构
  - 分层之所以能支持系统扩展，本质在于隔离关注点（separation of concerns）
  - 缺点，性能问题
- SOA
  - 解决传统 IT 行业系统重复建设和扩展效率低下的问题，SOA是为了将不同的系统整合起来
  - 三个关键概念
    - 服务
    - ESB（Enterprise Service Bus），SOA 用 ESB 来屏蔽异构系统对外提供各种不同接口方式
    - 松耦合
- 缺点：协议转换工作量和复杂度都很大，性能问题

## 34 深入理解微服务架构：银弹 or 焦油坑？
- Martin Fowler 提出？其推动微服务功不可没
- 微服务和 SOA 的关系
  - 观点：微服务是 SOA 的实现方式，微服务是更细粒度的 SOA
  - 观点：微服务是去掉 ESB 后的 SOA，去掉复杂的 ESB，使用轻量级的 HTTP
  - 观点：微服务是一种和 SOA 相似但本质上不同的架构理念（作者支持这个观点）

| 对比维度 | SOA         | 微服务                 |
|----------|-------------|------------------------|
| 服务粒度 | 粗          | 细                     |
| 服务通讯 | 重量级，ESB | 轻量级，如HTTP RESTful |
| 服务交付 | 慢          | 快                     |
| 应用场景 | 企业级      | 互联网                 |

微服务的陷阱
- 服务划分过细，服务间的关系复杂
- 服务数量太多，团队效率急剧下降
- 调用链太长，性能下降
- 调用链太长，问题定位困难
- 没有自动化支撑，无法快速交付
- 没有服务治理，微服务数据量多了后管理混乱

## 35 微服务架构最佳实践 - 方法篇
- 服务粒度
  - 两个披萨理论，每个团队的认数不能多到两张披萨都不够吃的地步
  - 三个火枪手：3个人负责一个微服务
- 拆分方法
  - 基于业务逻辑拆分，需要根据团队人数决定
  - 基于可扩展拆分，稳定的业务和易变化迭代的服务
  - 基于可靠性拆分，按模块优先级排序，好处
    - 避免非核心服务故障影响核心服务
    - 核心服务高可用方案更加简单
    - 降低高可用成本
  - 基于性能拆分
- 基础设施，按以下优先级来搭建
  1. 服务发现、服务路由、服务容错
  1. 接口框架、API 网关
  1. 自动化测试、自动化部署、配置中心
  1. 服务监控、服务跟踪、服务安全

## 36 微服务架构最佳实践 - 基础设施篇
- 自动化测试
- 自动化部署
- 配置中心
  - 版本管理、增删改查配置、节点管理、配置同步、配置推送等
- 接口框架
  - HTTP/REST 或 RPC
- API 网关
  - 对外部系统的访问
- 服务发现
  - 自理式：服务A自己访问 Service Registry 获取服务注册信息，然后直接访问服务B
  - 代理式：微服务之间有一个 Load Balancer 系统，该系统可能是瓶颈
- 服务路由
  - 发现服务后，需要挑出一个具体的节点发起请求
  - 通常和服务发现放在一起
  - 常见算法：随机路由、轮询路由、最小压力路由、最小连接数路由
- 服务容错
  - 请求重试、流控、服务隔离
  - 通常和服务发现、服务路由放在一起
- 服务监控
- 服务跟踪
  - 实现基本基于 Goole 的论文 Dapper, a Large-Scale Distributed Systems Tracing Infrastructure
- 服务安全
  - 接入安全
  - 数据安全
  - 传输安全
  - 可集成到配置中心实现？

## 37 微内核架构详解
- 微内核架构（Microkernel Architecture）也被称为插件化架构（Plug-in Architecture），包含两类组件：核心系统和插件模块
- 设计关键点
  - 插件管理，如何加载插件，常用插件注册表（配置文件、代码、数据库都可以）
  - 插件连接，插件如何连接到核心系统
    - 如 OSGi、消息模式、依赖注入、分布式协议等
  - 插件通信
