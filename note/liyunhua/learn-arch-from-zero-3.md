## 22 必须知道的 CAP 理论
http://robertgreiner.com/2014/08/cap-theorem-revisited/
- Consistency - A read is guaranteed to return the most recent write for a given client.
  对于某个客户端来说，读操作保证能够返回最新的写操作结果
- Availability - A non-failing node will return a reasonable response within a reasonable amount of time (no error or timeout).
  一个没有故障的节点在一个合理的时间范围内会返回一个合理的结果（没有超时或错误）
- Partition Tolerance - The system will continue to function when network partitions occur.
  系统在网络分区发生的时候会继续提供功能

zab 的读操作没有满足 CAP 的 C，TODO

## 23 必须知道的 CAP 细节
- CAP：强一致，忽略了同步时间因素
- ACID：原子性、一致性（数据不被破坏）、隔离性（并发地执行时）、持久性
  - 隔离性：Read Committed、Snapshot Isolation（也叫 Repeatable Read）、Serializable Isolation（可串行化隔离）
- BASE：是 CAP 理论中 AP 方案的延伸

## 24 FMEA 方法，排除架构可用性隐患的利器
- 墨菲定律：可能出错的事情最终都会出错
- FMEA：Failure mode and effects analysis，故障模式与影响分析
  - 给出初始的架构设计图
  - 假设架构中某个部件发生故障
  - 分析此故障对系统功能造成的影响
  - 根据分析结果，判断架构是否需要进行优化
1. 功能点：以用户视角来看
1. 故障模式：故障点与故障形式，只要现象即可
1. 故障影响：对功能点的影响，如功能点偶尔不可用，完全不可用，部分用户功能点不可用，功能点响应缓慢，功能点出错
1. 严重程度：一般分为“致命、高、中、低、无”
1. 故障原因：不同故障原因发生的概率，检测手段，处理措施
1. 故障概率：“高、中、低”，硬件、开源系统、自研系统
1. 风险程度：`= 严重程度*故障概率`
1. 已有措施：包括检测报警、容错、自恢复等
1. 规避措施：可以是技术手段也可以是管理手段
1. 解决措施：一般是技术手段
1. 后续规划：改进的规划，包括技术手段和管理手段

## 25 高可用存储架构：双机部署
- 复杂性主要体现在数据延迟和中断导致数据不一致的问题
- 主备、主从、主主、集群、分区
- 主主一般适合于那些临时性、可丢失、可覆盖的数据场景，如登录产生的 session 数据，行为的日志数据，论坛的草稿数据（可丢失）等

## 26 高可用存储架构：集群和分区
**数据集群**
- 数据集中集群
  - 主机如何将数据复制给备机
  - 主机故障后如何确定新机
- 数据分散集群
  - 均衡性
  - 容错性
  - 可伸缩性，加机器后，数据分区自动迁移到新服务器

**数据分区**
- 数据量
- 分区规则：洲分区、国家分区、城市分区
- 复制规则
  - 集中式，单独设置一个数据中心用来备份
  - 互备式
  - 独立式：每个数据中心有自己独立的备份中心

## 27 如何设计计算高可用架构
- 对称集群：所有机器一样的角色
- 非对称集群：有 Master Slave 之分

ZooKeeper 机制
- 任务分配：Follower 收到请求后，会将写请求转发给 Leader，如果是读请求就自己处理
- 角色指定：当 Leader 故障后，暂停读写操作，直到重新选举出 Leader 后再对外提供服务

## 28 业务高可用保障：异地多活架构
- 支付宝等系统，对于余额一般不做跨城异地多活，只采用同城异区（和一个机房差不多），必要的时候可以采取事后补偿机制
- 跨国异地：如亚马逊中国，亚马逊美国
- 只读业务做多活
- oceanbase 是怎么做的

## 29 异地多活设计4大技巧
1. 保证核心业务的异地多活：不要把想所有的业务都异地多活
1. 保证核心数据的一致性
   - 不可能完全同步
   - 尽量减少机房间的距离
   - 尽量减少数据同步，只同步核心业务相关的数据
   - 保证最终一致性，不保证实时一致性
   - 采用多种手段同步数据：避免只使用存储系统，如mysql、redis 提供的同步手段
1. 采用多种数据同步手段
   - 消息队列方式：
   - 二次读取方式：A中心数据还没同步到B中心，在B中心读不到，根据路由规则从A中心再读一次
   - 回源读取方式：A中心的 session 数据，在B中心读不到，根据 sessionid 去A中心查
   - 重新生成数据方式：异地session失败，从新登录
1. 只保证绝大部分用户异地多活

## 30 异地多活设计4步走
1. 业务分级
1. 数据分类，常见的数据分析维度
   - 数据量
   - 唯一性
   - 实时性
   - 可丢失性
   - 可恢复性
1. 数据同步
1. 异常处理：常见异常处理方案
   - 多通道同步，多种方案并存，需要使用不同的网络
   - 同步和访问结合：同步见上一章**多种数据同步手段**，访问可以优先访问本机房数据，不行再访问异地机房数据
   - 日志记录
   - 用户补偿
