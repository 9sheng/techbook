# 谁偷了你的磁盘
## 磁盘满了，但文件是空的，怎么办？

使用`df -hlT` 查看磁盘剩余空间，所剩无几：

```
[higkoo@TestServer ~]# df -hlT
Filesystem    Type    Size  Used Avail Use% Mounted on
/dev/sda1     ext3     20G  6.6G   12G  36% /
/dev/sda2      xfs    115G  103G   13G  89% /data
tmpfs        tmpfs    2.0G     0  2.0G   0% /dev/shm
```

而使用`du -sh`查看该分区磁盘占用量仅13G：
```
[higkoo@TestServer ~]# du -sh /data/
13G /data/
```

产生这个问题的根本原因是：文件确实是从文件系统中删除了，但没有从磁盘上删除。由于进程正在操作磁盘，待进程退出后操作才能被更新。所以，在删除文件前先看一下有谁正在读写。若有进程在占用某个文件，而其他进程把这文件删掉，只会删除其在磁盘中的标记，而不会释放其占用的磁盘空间；直到所有访问该文件的进程退出为止。

`df` 是从内核中获取磁盘占用情况数据的，而`du`是统计当前磁盘文件大小的结果，由于磁盘标记已被删掉，因此`du`不会计算上述被删除文件的空间，导致`df` 与`du`的结果不一致。同理，`ls -l`显示文件的大小，`du`显示占用磁盘空间的大小。

如何跟踪这类问题呢？答案：
```
lsof -n | grep deleted
COMMAND     PID      USER      FD      TYPE            DEVICE       SIZE       NODE NAME
dd        31708      higkoo    1w      REG                8,2 5523705856     429590 /data/filetest (deleted)

```
命令打`lsof -n | grep deleted`印出所有针对已删除文件的读写操作，这类操作是无效的，也正是磁盘空间莫名消失的根本原因！

用清空的方式，把文件指针重置，该文件所占用的空间也会马上释放出来。所以，对于常发生类似问题的文件，如：日志记录文件等。以改名、清空、删除的顺序操作也可避免问题。

## 文件空洞

文件读写时，如果先文件指针偏移很大一段，然后写入1byte；这样这个文件实际占用1byte空间，但是stat查看文件大小，或者读写时，都会发现文件很大；所有没有写内容的都返回0，且不占用空间，这样的文件叫 'sparse file'，即文件空洞

复制输出的文件将使空洞全填为字符0，文件实际大小和原空洞文件大小一致，但是空洞部分化为字符0占用磁盘空间：
```sh
cat file > file_copy
```
复制输出的文件不填平空洞，文件实际大小和原空洞文件大小一致，空洞部分仍是空洞，不占用磁盘空间：
```sh
cp file file_copy
```
